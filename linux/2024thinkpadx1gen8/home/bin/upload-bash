#!/usr/bin/env bash
#    screenshot-bash
#    Copyright (C) 2017-2021 Sefa Eyeoglu <contact@scrumplex.net> (https://scrumplex.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <https://www.gnu.org/licenses/>.
set -e


config_path="${XDG_CONFIG_HOME:-$HOME/.config}/screenshot-bash.conf"

if [ -n "$SCREENSHOT_BASH_CONFIG_PATH" ]; then
    config_path="$SCREENSHOT_BASH_CONFIG_PATH"
fi

if [ ! -f "$config_path" ]; then
    >&2 echo "Configuration file not found at $config_path"
    exit 1
fi

if [ $# -eq 0 ]; then
    >&2 echo "Usage: $0 [file]"
    exit 1
fi

if [ ! -f "$1" ]; then
    >&2 echo "Could not open file \"$1\"."
    exit 1
fi

# shellcheck source=screenshot-bash.conf
source "$config_path"

if [ -z "$TARGET_HOST" ] || [ -z "$PASSWORD" ]; then
    >&2 echo "TARGET_HOST or PASSWORD not specified!"
    exit 1

fi


case "$(file -b --mime-type "$1")" in
    image/*)
        directory="img"
        ;;

    video/*)
        directory="watch"
        ;;

    *)
        directory="cloud"
        ;;
esac

url="$TARGET_HOST/$directory"

filename="$(basename "$1")"

i=0

while curl -IsSLf "$url/$filename" > /dev/null 2>&1; do
    i=$((i+1))
    filename="${i}_$(basename "$1")"
done

curl --fail-with-body -sSLT "$1" -H "Authorization: Bearer $PASSWORD" -w "%{url_effective}" "$url/$filename"

echo ""

